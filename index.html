import turtle
import random
import time
import sys

# --- Cấu hình Màn hình ---
screen = turtle.Screen()
screen.setup(width=750, height=900)
screen.bgcolor("black")
screen.title("Dành Tặng Bích Chăm ❤️ - Lời Chúc Tình Yêu 20s")
screen.tracer(0) 

# --- Hằng số và Cấu hình ---
START_TIME = time.time()
DURATION = 20 # Hoạt ảnh sẽ chạy trong 20 giây
LOI_CHUC_COLORS = ["#FF69B4", "white", "#E77471", "#FFD700", "#ADD8E6"] # Hồng, Trắng, Đỏ San Hô, Vàng, Xanh Nhạt
HEART_COLORS = ["red", "pink", "lightcoral", "#FFB6C1", "#DC143C"] # Đỏ, Hồng, Đỏ San Hô, Hồng Nhạt, Đỏ Thẫm

# --- Danh sách Lời Chúc (Với tên Bích Chăm) ---
LOI_CHUC = [
    "Bích Chăm, anh yêu em nhiều lắm! ❤️",
    "Mãi mãi là của nhau nhé, Bích Chăm! 💍",
    "Chúc Bích Chăm luôn xinh đẹp & hạnh phúc! 😊",
    "Em là nguồn sáng của đời anh, Bích Chăm!",
    "Yêu em hơn cả lời nói! 💖",
    "Gửi ngàn nụ hôn tới Bích Chăm! 😘",
    "Cảm ơn em đã đến bên anh, Bích Chăm!",
    "Tình yêu của chúng ta là mãi mãi!",
    "Thế giới này thật đẹp vì có Bích Chăm!",
    "Mỗi ngày bên em là một món quà! 🎁",
    "Anh sẽ luôn nắm tay em, Bích Chăm!",
    "Trái tim anh chỉ có hình bóng Bích Chăm!",
    "Hạnh phúc là được thấy em cười! 😄",
    "Bích Chăm là người tuyệt vời nhất!",
    "Tình yêu này là vô tận! ✨"
]

# --- Class đối tượng Lời Chúc ---
class LờiChúc:
    def __init__(self, message):
        self.pen = turtle.Turtle()
        self.pen.hideturtle()
        self.pen.color(random.choice(LOI_CHUC_COLORS))
        self.pen.penup()
        
        # Vị trí xuất hiện ngẫu nhiên ở dưới đáy màn hình
        self.x = random.uniform(-screen.window_width()/2 + 150, screen.window_width()/2 - 150)
        self.y = -screen.window_height() / 2 - 50 
        
        self.pen.goto(self.x, self.y)
        self.message = message
        self.speed = random.uniform(1.0, 2.5) 
        self.font_size = random.randint(14, 18)

    def move(self):
        self.y += self.speed
        self.pen.clear()
        self.pen.goto(self.x, self.y)
        self.pen.write(self.message, align="center", font=("Arial", self.font_size, "bold"))

    def is_visible(self):
        return self.y < screen.window_height() / 2 + 50

    def cleanup(self):
        self.pen.clear()
        del self.pen

# --- Class đối tượng Trái Tim (Heart) ---
class Tim:
    def __init__(self):
        self.pen = turtle.Turtle()
        self.pen.hideturtle()
        self.pen.shape("circle")
        self.pen.shapesize(random.uniform(0.1, 0.4)) 
        self.pen.color(random.choice(HEART_COLORS))
        self.pen.penup()

        # Vị trí xuất hiện ngẫu nhiên ở nửa dưới màn hình
        self.x = random.uniform(-screen.window_width() / 2, screen.window_width() / 2)
        self.y = random.uniform(-screen.window_height() / 2, -screen.window_height() / 2 + 150) 
        
        self.pen.goto(self.x, self.y)
        self.speed_y = random.uniform(2.5, 4.5) 
        self.speed_x = random.uniform(-1.5, 1.5) 
        self.pen.showturtle()
        self.initial_color = self.pen.color()[0]

    def move(self):
        self.y += self.speed_y
        self.x += self.speed_x
        self.pen.goto(self.x, self.y)
        
        # Hiệu ứng lấp lánh nhẹ
        if random.random() < 0.1: # 10% cơ hội mỗi lần cập nhật
             self.pen.color("white")
        else:
             self.pen.color(self.initial_color)


    def is_visible(self):
        return self.y < screen.window_height() / 2 + 50

    def cleanup(self):
        self.pen.hideturtle()
        del self.pen

# --- Vòng lặp chính ---
current_messages = []
current_hearts = []
last_message_time = time.time()
last_heart_time = time.time()
message_interval = 2.0 # Lời chúc xuất hiện nhanh hơn
heart_interval = 0.05  # Trái tim xuất hiện rất nhanh và liên tục

def create_new_message():
    message = random.choice(LOI_CHUC)
    new_message = LờiChúc(message)
    current_messages.append(new_message)

def create_new_hearts(count=4):
    for _ in range(count):
        new_heart = Tim()
        current_hearts.append(new_heart)

def animate():
    global last_message_time, last_heart_time
    current_time = time.time()
    elapsed_time = current_time - START_TIME

    # --- Kiểm tra điều kiện kết thúc (20 giây) ---
    if elapsed_time > DURATION + 2: # Cộng thêm 2s để các đối tượng cuối kịp bay lên
        # Dọn dẹp tất cả đối tượng còn lại và đóng chương trình
        for item in current_messages + current_hearts:
            try:
                item.cleanup()
            except:
                pass
        screen.bye()
        return

    # --- Tạo Lời Chúc mới ---
    if current_time - last_message_time > message_interval and elapsed_time < DURATION:
        create_new_message()
        last_message_time = current_time

    # --- Tạo Trái Tim mới (Liên tục) ---
    if current_time - last_heart_time > heart_interval and elapsed_time < DURATION:
        create_new_hearts(count=random.randint(3, 6)) 
        last_heart_time = current_time

    # --- Di chuyển và Xoá (Lời Chúc) ---
    new_messages = []
    for msg in current_messages:
        msg.move()
        if msg.is_visible():
            new_messages.append(msg)
        else:
            msg.cleanup()
    current_messages[:] = new_messages

    # --- Di chuyển và Xoá (Trái Tim) ---
    new_hearts = []
    for heart in current_hearts:
        heart.move()
        if heart.is_visible():
            new_hearts.append(heart)
        else:
            heart.cleanup()
    current_hearts[:] = new_hearts


    screen.update()
    screen.ontimer(animate, 10) # Lặp lại hoạt ảnh sau 10ms

# Bắt đầu hoạt ảnh
animate()

# Để chương trình chạy cho đến khi được gọi screen.bye()
# Dùng try-except để tránh lỗi khi người dùng đóng cửa sổ
try:
    screen.mainloop()
except turtle.Terminator:
    print("Hoạt ảnh đã kết thúc.")
except Exception as e:
    print(f"Có lỗi xảy ra: {e}")
